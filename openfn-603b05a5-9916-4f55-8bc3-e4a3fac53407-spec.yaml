name: dpga-brazil
description: null
collections: null
credentials:
  international@open.gov.sg-OpenFn-Test:
    name: OpenFn Test
    owner: international@open.gov.sg
  international@open.gov.sg-Sunbird-Demo-Instance:
    name: Sunbird Demo Instance
    owner: international@open.gov.sg
  taylor@openfn.org-TD-Mailgun:
    name: TD Mailgun
    owner: taylor@openfn.org
  taylor@openfn.org-TD-Sunbird-RC-Test:
    name: TD Sunbird RC Test
    owner: taylor@openfn.org
workflows:
  DHIS2-to-OpenCRVS-via-XRoad:
    name: DHIS2-to-OpenCRVS-via-XRoad
    jobs:
      Fetch-TEIs-from-DHIS2-via-X-Road:
        name: Fetch TEIs from DHIS2 via X-Road
        adaptor: '@openfn/language-dhis2@latest'
        credential: null
        body: |
          // Add operations here
      Transform-TEIs-to-National-Standard:
        name: Transform TEIs to National Standard
        adaptor: '@openfn/language-claude@1.0.14'
        credential: null
        body: |
          // Add operations here
      Create-IDs-in-OpenCRVS-via-X-Road:
        name: Create IDs in OpenCRVS via X-Road
        adaptor: '@openfn/language-opencrvs@latest'
        credential: null
        body: |
          // Add operations here
      analyze-error:
        name: analyze error
        adaptor: '@openfn/language-chatgpt@2.0.3'
        credential: null
        body: |
          // Add operations here
      Send-DPI-downtime-alert:
        name: Send DPI downtime alert
        adaptor: '@openfn/language-mailgun@0.5.19'
        credential: null
        body: |
          // Add operations here
      add-to-dashboard:
        name: add to dashboard
        adaptor: '@openfn/language-azure-storage@3.0.2'
        credential: null
        body: |
          // Check out the Job Writing Guide for help getting started:
          // https://docs.openfn.org/documentation/jobs/job-writing-guide

    triggers:
      webhook:
        type: webhook
        enabled: false
    edges:
      webhook->Fetch-TEIs-from-DHIS2-via-X-Road:
        source_trigger: webhook
        target_job: Fetch-TEIs-from-DHIS2-via-X-Road
        condition_type: always
        enabled: true
      Fetch-TEIs-from-DHIS2-via-X-Road->Transform-TEIs-to-National-Standard:
        source_job: Fetch-TEIs-from-DHIS2-via-X-Road
        target_job: Transform-TEIs-to-National-Standard
        condition_type: on_job_success
        enabled: true
      Transform-TEIs-to-National-Standard->Create-IDs-in-OpenCRVS-via-X-Road:
        source_job: Transform-TEIs-to-National-Standard
        target_job: Create-IDs-in-OpenCRVS-via-X-Road
        condition_type: on_job_success
        enabled: true
      Fetch-TEIs-from-DHIS2-via-X-Road->analyze-error:
        source_job: Fetch-TEIs-from-DHIS2-via-X-Road
        target_job: analyze-error
        condition_type: on_job_failure
        enabled: true
      Transform-TEIs-to-National-Standard->analyze-error:
        source_job: Transform-TEIs-to-National-Standard
        target_job: analyze-error
        condition_type: on_job_failure
        enabled: true
      Create-IDs-in-OpenCRVS-via-X-Road->analyze-error:
        source_job: Create-IDs-in-OpenCRVS-via-X-Road
        target_job: analyze-error
        condition_type: on_job_failure
        enabled: true
      analyze-error->Send-DPI-downtime-alert:
        source_job: analyze-error
        target_job: Send-DPI-downtime-alert
        condition_type: on_job_success
        enabled: true
      analyze-error->add-to-dashboard:
        source_job: analyze-error
        target_job: add-to-dashboard
        condition_type: on_job_success
        enabled: true
  FormSG-and-Sunbird-RC:
    name: FormSG and Sunbird RC
    jobs:
      Verify-and-Decrypt-Responses:
        name: Verify and Decrypt Responses
        adaptor: '@openfn/language-formsg@1.0.1'
        credential: international@open.gov.sg-OpenFn-Test
        body: |
          decryptSubmission($.data.data, {
            verifySignature: true,
            signatureHeader: $.request.headers['x-formsg-signature']
          })
      Transform-Form-Data-and-Fetch-Course-Score:
        name: Transform Form Data and Fetch Course Score
        adaptor: '@openfn/language-common@latest'
        credential: null
        body: |
          function getAnswer(responses, label) {
            const f = responses.find(r => r.question === label);
            return f ? f.answer : null;
          }

          function generateDemoGrade() {
            const base = 8.5 + Math.random() * 1.4; // 8.5 â€“ 9.9
            const rounded = Math.round(base * 100) / 100;
            return `${rounded} / 10 (Distinction)`;
          }

          fn(state => {
            const responses = state.data.responses || state.data.data?.responses || [];

            const name = getAnswer(responses, 'Name') || 'Learner';
            const email = getAnswer(responses, 'Email') || 'unknown@example.com';
            const phone = getAnswer(responses, 'Mobile') || '+65-0000-0000';
            const programme = getAnswer(responses, 'Course') || 'Data Analytics';

            
          // In real life use cases, this is fetched from an external system
          // But for simplicity of demo: just generate it here as mocked data
            const grade = generateDemoGrade();

            state.data.normalized = {
              name,
              email,
              phone,
              programme,
              grade
            };

            return state;
          });

      Issue-a-Verifiable-Credential:
        name: Issue a Verifiable Credential
        adaptor: '@openfn/language-sunbird-rc@1.0.0'
        credential: taylor@openfn.org-TD-Sunbird-RC-Test
        body: |
          issueCredential({
            credential: {
              "@context": [
                "https://www.w3.org/2018/credentials/v1",
                "https://littlemight.github.io/sunbird-demo-vc-context/demo-context.json"
              ],
              "type": [
                "VerifiableCredential",
                "ProofOfAcademicEvaluationCredential"
              ],
              "issuer": "did:web:example.com:identifier:9536bc3b-3f4b-4cec-8c48-f67c9c4d63fc",
              "issuanceDate": new Date().toISOString(),
              "expirationDate": new Date(new Date().setFullYear(new Date().getFullYear() + 2)).toISOString(),
              "credentialSubject": {
                "id": "did:schema:7b2fc25c-b7f6-40b5-bee4-d95bb5924450",
                "type": "ProofOfAcademicEvaluationCredential",
                "name": $.data.normalized.name,
                "grade": $.data.normalized.grade,
                "programme": $.data.normalized.programme,
                "certifyingInstitute": "YourSkillsFuture Council",
                "evaluatingInstitute": "Institute of Digital Learning, India",
              }
            },
            "credentialSchemaId": "did:schema:7b2fc25c-b7f6-40b5-bee4-d95bb5924450",
            "credentialSchemaVersion": "1.0.0",
            "tags": ["demo", "education", "cross-border"]
          })
      Fetch-certificate-as-PDF:
        name: Fetch certificate as PDF
        adaptor: '@openfn/language-sunbird-rc@1.0.0'
        credential: taylor@openfn.org-TD-Sunbird-RC-Test
        body: |
          fn(state => ({ ...state, credentialId: state.data.credential.id }))

          getCredential($.credentialId, {
            templateId: 'cmhbkgjqo000ems0jvbeayn1h',
          });

          fn(state => ({ ...state, proof: state.data }));

          downloadCredential($.credentialId, {
            templateId: 'cmhbkgjqo000ems0jvbeayn1h',
          });
      Deliver-to-citizen:
        name: Deliver to citizen
        adaptor: '@openfn/language-mailgun@latest'
        credential: taylor@openfn.org-TD-Mailgun
        body: |
          send({
            from: 'admin@openfn.org',
            to: [
              'taylor@openfn.org',
              'cheryl@open.gov.sg',
              'michel@open.gov.sg',
              'kartheek@sanketika.in',
              'jack@openfn.org',
              'pius@openfn.org',
              'mohit@coss.org.in',
            ],
            subject: 'You have a new âœ¨ verifiable credential! ðŸ‘',
            text: 'ðŸ¥³ Congratulations! The deatils are below and Ã¥ PDF version is attached.\n\n'
              + `Subject: ${JSON.stringify($.proof.credentialSubject, null, 2)}\n\n`
              + `Proof: ${JSON.stringify($.proof.proof, null, 2)}\n\n`
              + `Best,\n`
              + `Your Government`,
            attachment: {
              filename: 'credential.pdf',
              data: $.data
            },
          });
      Notify-if-invalid:
        name: Notify if invalid
        adaptor: '@openfn/language-mailgun@0.5.21'
        credential: taylor@openfn.org-TD-Mailgun
        body: |
          send({
            from: 'admin@openfn.org',
            to: ['taylor@openfn.org'],
            subject: 'Could not issue credential',
            text: 'We could not issue a verifiable credential for: \n\n'
              + `Subject: ${JSON.stringify($.data.normalized, null, 2)}\n\n`
              + `Best,\n`
              + `Your Government`
          });
      Alert-institution-credential-issuance:
        name: Alert institution credential issuance
        adaptor: '@openfn/language-mailgun@0.5.21'
        credential: taylor@openfn.org-TD-Mailgun
        body: |
          send({
            from: 'admin@openfn.org',
            to: [
              'taylor@openfn.org',
              'cheryl@open.gov.sg',
              'michel@open.gov.sg',
              'kartheek@sanketika.in',
              'jack@openfn.org',
              'pius@openfn.org',
              'mohit@coss.org.in',
            ],
            subject: 'New credential issued',
            text: 'A new credential has just been issued: \n\n'
              + `Subject: ${JSON.stringify($.proof.credentialSubject, null, 2)}\n\n`
              + `Proof: ${JSON.stringify($.proof.proof, null, 2)}\n\n`
              + `Best,\n`
              + `Your Government`
          });
    triggers:
      webhook:
        type: webhook
        enabled: true
    edges:
      webhook->Verify-and-Decrypt-Responses:
        source_trigger: webhook
        target_job: Verify-and-Decrypt-Responses
        condition_type: always
        enabled: true
      Verify-and-Decrypt-Responses->Transform-Form-Data-and-Fetch-Course-Score:
        source_job: Verify-and-Decrypt-Responses
        target_job: Transform-Form-Data-and-Fetch-Course-Score
        condition_type: on_job_success
        enabled: true
      Transform-Form-Data-and-Fetch-Course-Score->Issue-a-Verifiable-Credential:
        source_job: Transform-Form-Data-and-Fetch-Course-Score
        target_job: Issue-a-Verifiable-Credential
        condition_type: on_job_success
        enabled: true
      Issue-a-Verifiable-Credential->Fetch-certificate-as-PDF:
        source_job: Issue-a-Verifiable-Credential
        target_job: Fetch-certificate-as-PDF
        condition_type: on_job_success
        enabled: true
      Fetch-certificate-as-PDF->Deliver-to-citizen:
        source_job: Fetch-certificate-as-PDF
        target_job: Deliver-to-citizen
        condition_type: on_job_success
        enabled: true
      Issue-a-Verifiable-Credential->Notify-if-invalid:
        source_job: Issue-a-Verifiable-Credential
        target_job: Notify-if-invalid
        condition_type: on_job_failure
        enabled: true
      Fetch-certificate-as-PDF->Alert-institution-credential-issuance:
        source_job: Fetch-certificate-as-PDF
        target_job: Alert-institution-credential-issuance
        condition_type: on_job_success
        enabled: false
